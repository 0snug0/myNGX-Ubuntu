js_include conf.d/functions.conf;
limit_req_zone $http_remote_addr zone=proxy:10m rate=1r/s;

upstream wafdemo1{
  zone wafdemo1 64k;
  hash $http_user_agent.$remote_addr;
  server 172.28.128.9:32769;
  server 172.28.128.9:32771;
  server 172.28.128.9:32773;
}

server {
  listen 80;
  status_zone waf;

  modsecurity on;
  modsecurity_rules_file /etc/nginx/modsec/main.conf;


  location / {
    limit_req zone=proxy burst=5;
    proxy_pass http://wafdemo1;
    proxy_set_header Host $host;
    health_check;
  }
}

## NGINX Plus Dashboard
server {
  listen 8080;
  root /usr/share/nginx/html;

  location = / {
    return 301 /status.html;
  }

  location = /status.html { }

  location /status {
    status;
  }
}
